name: Performance Tier Check

on:
  pull_request_target:

# Minimal permissions for security
permissions:
  contents: read
  pull-requests: write

jobs:
  check:
    runs-on: ubuntu-24.04
    steps:
      - name: check if sse2neon.h changed
        id: changed
        uses: actions/github-script@v7
        with:
          script: |
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              per_page: 100
            });
            const changed = files.some(f => f.filename === 'sse2neon.h');
            core.setOutput('sse2neon_changed', changed ? 'true' : 'false');
            if (!changed) {
              console.log('sse2neon.h not modified, skipping perf-tier check');
            }

      # SECURITY: Only checkout BASE repository code, never fork code
      # This is safe with pull_request_target because we only run trusted code
      - name: checkout base code
        if: steps.changed.outputs.sse2neon_changed == 'true'
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          persist-credentials: false
          fetch-depth: 1

      - name: setup Python
        if: steps.changed.outputs.sse2neon_changed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: install dependencies
        if: steps.changed.outputs.sse2neon_changed == 'true'
        run: |
          sudo apt-get update -q -y
          sudo apt-get install -q -y unifdef libclang-dev
          pip install clang

      - name: fetch PR files for analysis
        if: steps.changed.outputs.sse2neon_changed == 'true'
        run: |
          git fetch origin pull/${{ github.event.pull_request.number }}/head:pr-head
          # Fetch sse2neon.h (required) and perf-tier.md (if updated in PR)
          git checkout pr-head -- sse2neon.h
          git checkout pr-head -- perf-tier.md 2>/dev/null || true

      - name: check perf-tier.md
        if: steps.changed.outputs.sse2neon_changed == 'true'
        id: check
        run: |
          if sh .ci/check-perf-tier.sh; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: post reminder comment
        if: steps.changed.outputs.sse2neon_changed == 'true' && steps.check.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;

            const body = [
              '### Performance Tier Documentation Reminder',
              '',
              'The `perf-tier.md` file appears to be out of sync with the current `sse2neon.h` implementation.',
              '',
              'This is **not an error** - just a reminder to update the documentation if your changes affect intrinsic implementations.',
              '',
              'To regenerate the performance tier report:',
              '```bash',
              'python3 scripts/gen-perf-report.py --clang-ast --weighted > perf-tier.md',
              '```',
              '',
              'For detailed analysis:',
              '```bash',
              'python3 scripts/analyze-tiers.py --clang-ast --weighted --markdown',
              '```'
            ].join('\n');

            // Check if we already posted this comment
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('Performance Tier Documentation Reminder')
            );

            if (!botComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
              console.log(`Posted comment on PR #${prNumber}`);
            } else {
              console.log(`Comment already exists on PR #${prNumber}`);
            }
