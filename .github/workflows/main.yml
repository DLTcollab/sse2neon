name: GitHub Actions

on:
  push:
  pull_request:
  workflow_dispatch:

# Least-privilege permissions
permissions:
  contents: read
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  host-x86:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        cxx_compiler: [g++, clang++-18]
    steps:
      - name: checkout code
        uses: actions/checkout@v6
      - name: install build dependencies
        run: |
          sudo apt-get update -q -y
          sudo apt-get install -q -y clang-18
      - name: build artifact
        env:
          CXX: ${{ matrix.cxx_compiler }}
        run: |
          sh .ci/cross-tool.sh
          make check
          sh .ci/cross-check.sh

  host-win:
    runs-on: windows-2022
    strategy:
      matrix:
        arch: [x86_64, armv7, aarch64]
    env:
      LLVM_MINGW_URL: https://github.com/mstorsjo/llvm-mingw/releases/download/20251118/llvm-mingw-20251118-msvcrt-x86_64.zip
    defaults:
      run:
        shell: bash
    steps:
      - name: unpack llvm-mingw
        run: |
          curl -L -O $LLVM_MINGW_URL
          unzip -q llvm-mingw-*.zip
          rm llvm-mingw-*.zip
          mv llvm-mingw-* "$HOME/llvm-mingw"
          echo "$HOME/llvm-mingw/bin" >> $GITHUB_PATH
      - name: checkout code
        uses: actions/checkout@v6
      - name: build artifact
        env:
          CXX: ${{ matrix.arch }}-w64-mingw32-clang++
        run: mingw32-make processor=${{ matrix.arch }}
      - name: run tests
        if: matrix.arch == 'x86_64'
        run: mingw32-make check

  # Native AArch64 on GitHub ARM runners - fast, no QEMU overhead
  host-arm-native:
    runs-on: ubuntu-24.04-arm
    strategy:
      matrix:
        include:
          - cxx_compiler: g++
            feature: crypto+crc
            strict_aliasing: false
          - cxx_compiler: clang++-18
            feature: crypto+crc
            strict_aliasing: false
          - cxx_compiler: g++
            feature: none
            strict_aliasing: false
          - cxx_compiler: g++
            feature: crypto+crc
            strict_aliasing: true
    steps:
      - name: checkout code
        uses: actions/checkout@v6
      - name: install build dependencies
        run: |
          sudo apt-get update -q -y
          sudo apt-get install -q -y clang-18
      - name: build and test
        env:
          CXX: ${{ matrix.cxx_compiler }}
        run: |
          if [ "${{ matrix.strict_aliasing }}" = "true" ]; then
            make FEATURE=${{ matrix.feature }} STRICT_ALIASING=1 check
          else
            make FEATURE=${{ matrix.feature }} check
          fi

  # ARMv7 requires QEMU emulation - minimize job count
  host-arm-emulated:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        include:
          - arch: armv7
            cxx_compiler: g++
            arch_cflags: none
            strict_aliasing: false
          - arch: armv7
            cxx_compiler: g++
            arch_cflags: '-mcpu=cortex-a32 -mfpu=neon-fp-armv8'
            strict_aliasing: false
          - arch: armv7
            cxx_compiler: g++
            arch_cflags: none
            strict_aliasing: true
    steps:
      - name: checkout code
        uses: actions/checkout@v6
      - name: build artifact
        uses: uraimo/run-on-arch-action@v3
        with:
          arch: ${{ matrix.arch }}
          distro: ubuntu24.04
          githubToken: ${{ github.token }}
          env: |
            CXX: ${{ matrix.cxx_compiler }}
            ARCH_CFLAGS: ${{ matrix.arch_cflags }}
          install: |
            rm -rf /var/lib/apt/lists/*
            apt-get -o Acquire::Retries=5 update
            apt-get -o Acquire::Retries=5 -o Dpkg::Use-Pty=0 install -y --no-install-recommends gcc g++ make
            apt-get clean && rm -rf /var/lib/apt/lists/*
          run: |
            if [ "${{ matrix.strict_aliasing }}" = "true" ]; then
              make STRICT_ALIASING=1 check
            else
              make check
            fi

  host-win-msvc:
    runs-on: windows-2022
    steps:
      - name: checkout code
        uses: actions/checkout@v6

      - name: add msbuild to PATH
        uses: microsoft/setup-msbuild@v2

      - name: build artifact
        run: msbuild sse2neon.vcxproj -t:rebuild -property:Configuration=Release -property:Platform=ARM64

      - name: upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: msvc-arm64-artifact
          path: ARM64

  test-win-msvc:
    runs-on: ubuntu-24.04
    container: linaro/wine-arm64
    needs: host-win-msvc
    steps:
      - name: download artifact
        uses: actions/download-artifact@v6
        with:
          name: msvc-arm64-artifact

      - name: Run tests
        run: wine-arm64 cmd.exe /c 'Release\sse2neon.exe'

  # Sanitizers on ARM: UBSan + ASan per IMPROVE.md H5
  sanitizers-arm:
    runs-on: ubuntu-24.04-arm
    strategy:
      matrix:
        include:
          - sanitizer: undefined
            cxx_compiler: g++
          - sanitizer: address
            cxx_compiler: g++
    steps:
      - name: checkout code
        uses: actions/checkout@v6
      - name: build and test with sanitizer
        env:
          CXX: ${{ matrix.cxx_compiler }}
          UBSAN_OPTIONS: print_stacktrace=1:halt_on_error=1
          ASAN_OPTIONS: detect_leaks=1:halt_on_error=1
        run: make FEATURE=crypto+crc SANITIZE=${{ matrix.sanitizer }} check

  # Sanitizers on x86: catch host-specific UB
  sanitizers-x86:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        include:
          - sanitizer: undefined
            cxx_compiler: g++
          - sanitizer: address
            cxx_compiler: g++
    steps:
      - name: checkout code
        uses: actions/checkout@v6
      - name: build and test with sanitizer
        env:
          CXX: ${{ matrix.cxx_compiler }}
          UBSAN_OPTIONS: print_stacktrace=1:halt_on_error=1
          ASAN_OPTIONS: detect_leaks=1:halt_on_error=1
        run: make SANITIZE=${{ matrix.sanitizer }} check

  static-analysis:
    runs-on: ubuntu-24.04
    env:
      LLVM_VERSION: 20
    steps:
      - name: checkout code
        uses: actions/checkout@v6
      - name: install clang tools
        run: |
          wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | sudo tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
          sudo add-apt-repository -y "deb http://apt.llvm.org/noble/ llvm-toolchain-noble-$LLVM_VERSION main"
          sudo apt-get update -q -y
          sudo apt-get install -q -y clang-format-$LLVM_VERSION clang-tidy-$LLVM_VERSION \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
      - name: style check
        run: sh .ci/check-format.sh
        shell: bash
      - name: cast macro validation
        run: python3 .ci/check-casts.py --strict sse2neon.h
      - name: preprocessor macro hygiene
        run: python3 .ci/check-macros.py sse2neon.h
      - name: clang-tidy
        run: |
          clang-tidy-$LLVM_VERSION sse2neon.h \
            --warnings-as-errors='' \
            -- -x c++ -std=gnu++14 -I. \
            --target=aarch64-linux-gnu \
            --gcc-toolchain=/usr \
            -isystem /usr/aarch64-linux-gnu/include \
            -march=armv8-a+simd+crypto+crc
