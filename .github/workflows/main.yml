name: GitHub Actions

on:
  push:
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  host-x86:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        arch: [x86_64]
        cxx_compiler: [g++, clang++-18]
    steps:
      - name: checkout code
        uses: actions/checkout@v6
      - name: install build dependencies
        run: |
          sudo apt-get update -q -y
          sudo apt-get install -q -y clang-18
      - name: build artifact
        env:
          CXX: ${{ matrix.cxx_compiler }}
        run: |
          sh .ci/cross-tool.sh
          make check
          sh .ci/cross-check.sh

  host-win:
    runs-on: windows-2022
    strategy:
      matrix:
        arch:
          - x86_64
          - armv7
          - aarch64
    env:
      LLVM_MINGW_URL: https://github.com/mstorsjo/llvm-mingw/releases/download/20251118/llvm-mingw-20251118-msvcrt-x86_64.zip
    defaults:
      run:
        shell: bash
    steps:
      - name: unpack llvm-mingw
        run: |
          curl -L -O $LLVM_MINGW_URL
          unzip -q llvm-mingw-*.zip
          rm llvm-mingw-*.zip
          mv llvm-mingw-* "$HOME/llvm-mingw"
          echo "$HOME/llvm-mingw/bin" >> $GITHUB_PATH
      - name: checkout code
        uses: actions/checkout@v6
      - name: build artifact
        env:
          CXX: ${{ matrix.arch }}-w64-mingw32-clang++
        run: mingw32-make processor=${{ matrix.arch }}
      - name: run tests
        if: matrix.arch == 'x86_64'
        run: mingw32-make check

  host-arm:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        arch_with_features: [
          {arch: armv7, feature: none, arch_cflags: none},
          {arch: aarch64, feature: none, arch_cflags: none},
          {arch: aarch64, feature: crypto+crc, arch_cflags: none},
          {arch: armv7, feature: none, arch_cflags: '-mcpu=cortex-a32 -mfpu=neon-fp-armv8'}
        ]
        cxx_compiler: [g++, clang++-18]
    steps:
      - name: checkout code
        uses: actions/checkout@v6
      - name: build artifact
        # The Github Action for non-x86 CPU
        # https://github.com/uraimo/run-on-arch-action
        uses: uraimo/run-on-arch-action@v3
        with:
          arch: ${{ matrix.arch_with_features.arch }}
          distro: ubuntu24.04
          # Speed up builds by storing container images in a GitHub package registry.
          githubToken: ${{ github.token }}
          env: |
            CXX: ${{ matrix.cxx_compiler }}
            ARCH_CFLAGS: ${{ matrix.arch_with_features.arch_cflags }}
          install: |
            rm -rf /var/lib/apt/lists/*
            apt-get -o Acquire::Retries=5 update
            apt-get -o Acquire::Retries=5 -o Dpkg::Use-Pty=0 install -y --no-install-recommends clang-18 gcc g++ make
            apt-get clean && rm -rf /var/lib/apt/lists/*
          run: |
            make FEATURE=${{ matrix.arch_with_features.feature }} check

  host-win-msvc:
    runs-on: windows-2022
    steps:
      - name: checkout code
        uses: actions/checkout@v6

      - name: add msbuild to PATH
        uses: microsoft/setup-msbuild@v2

      - name: build artifact
        run: msbuild sse2neon.vcxproj -t:rebuild -property:Configuration=Release -property:Platform=ARM64

      - name: upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: msvc-arm64-artifact
          path: ARM64

  test-win-msvc:
    runs-on: ubuntu-24.04
    container: linaro/wine-arm64
    needs: host-win-msvc
    steps:
      - name: download artifact
        uses: actions/download-artifact@v6
        with:
          name: msvc-arm64-artifact

      - name: Run tests
        run: wine-arm64 cmd.exe /c 'Release\sse2neon.exe'

  sanitizers:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        sanitizer: [undefined]
        cxx_compiler: [g++, clang++-18]
    steps:
      - name: checkout code
        uses: actions/checkout@v6
      - name: install build dependencies
        run: |
          sudo apt-get update -q -y
          sudo apt-get install -q -y clang-18
      - name: build and test with sanitizer
        env:
          CXX: ${{ matrix.cxx_compiler }}
          UBSAN_OPTIONS: print_stacktrace=1:halt_on_error=1
        run: make SANITIZE=${{ matrix.sanitizer }} check

  static-analysis:
    runs-on: ubuntu-24.04
    env:
      LLVM_VERSION: 20
    steps:
      - name: checkout code
        uses: actions/checkout@v6
      - name: install clang tools
        run: |
          wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | sudo tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
          sudo add-apt-repository -y "deb http://apt.llvm.org/noble/ llvm-toolchain-noble-$LLVM_VERSION main"
          sudo apt-get update -q -y
          sudo apt-get install -q -y clang-format-$LLVM_VERSION clang-tidy-$LLVM_VERSION \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
      - name: style check
        run: sh .ci/check-format.sh
        shell: bash
      - name: clang-tidy
        run: |
          clang-tidy-$LLVM_VERSION sse2neon.h \
            --warnings-as-errors='' \
            -- -x c++ -std=gnu++14 -I. \
            --target=aarch64-linux-gnu \
            --gcc-toolchain=/usr \
            -isystem /usr/aarch64-linux-gnu/include \
            -march=armv8-a+simd+crypto+crc

  perf-tier-check:
    runs-on: ubuntu-24.04
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    steps:
      - name: checkout code
        uses: actions/checkout@v6
      - name: setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - name: install unifdef
        run: sudo apt-get install -y unifdef
      - name: check perf-tier.md
        id: check
        run: |
          if sh .ci/check-perf-tier.sh; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true
      - name: post reminder comment
        if: steps.check.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const body = [
              '### Performance Tier Documentation Reminder',
              '',
              'The `perf-tier.md` file appears to be out of sync with the current `sse2neon.h` implementation.',
              '',
              'This is **not an error** - just a reminder to update the documentation if your changes affect intrinsic implementations.',
              '',
              'To regenerate the performance tier report:',
              '```bash',
              'python3 scripts/gen-perf-report.py > perf-tier.md',
              '```',
              '',
              'For detailed analysis:',
              '```bash',
              'python3 scripts/analyze-tiers.py --markdown',
              '```'
            ].join('\n');

            // Check if we already posted this comment (paginate to handle PRs with many comments)
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              per_page: 100,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('Performance Tier Documentation Reminder')
            );

            if (!botComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
